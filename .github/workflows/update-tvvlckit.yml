name: Update TVVLCKit Framework

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allows manual triggering

jobs:
  check-and-update:
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Check for latest VLCKit release
        id: check-version
        run: |
          echo "Checking for latest TVVLCKit release..."
          
          # Get latest release info from VideoLAN's CocoaPods feed
          # Parse the download page to find the latest TVVLCKit version
          LATEST_VERSION=$(curl -s "https://download.videolan.org/cocoapods/prod/" | \
            grep -o 'TVVLCKit-[0-9.]*-[a-f0-9]*-[a-f0-9]*.tar.xz' | \
            sed 's/TVVLCKit-//' | \
            sed 's/-.*//' | \
            sort -V | \
            tail -1)
          
          echo "Latest version found: $LATEST_VERSION"
          
          # Get current version from Package.swift
          CURRENT_VERSION=$(grep -o 'download/v[0-9.]*' Package.swift | head -1 | sed 's/download\/v//' || echo "0.0.0")
          echo "Current version: $CURRENT_VERSION"
          
          # Find the full download URL for the latest version
          DOWNLOAD_URL=$(curl -s "https://download.videolan.org/cocoapods/prod/" | \
            grep -o "TVVLCKit-${LATEST_VERSION}-[a-f0-9]*-[a-f0-9]*.tar.xz" | \
            head -1)
          
          echo "Download file: $DOWNLOAD_URL"
          echo "Full URL: https://download.videolan.org/cocoapods/prod/$DOWNLOAD_URL"
          
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "download_url=https://download.videolan.org/cocoapods/prod/$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          
          if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Update available: $CURRENT_VERSION -> $LATEST_VERSION"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Already up to date"
          fi

      - name: Download and repackage framework
        if: steps.check-version.outputs.update_available == 'true'
        id: package
        run: |
          set -e
          
          VERSION="${{ steps.check-version.outputs.latest_version }}"
          TVOS_URL="${{ steps.check-version.outputs.download_url }}"
          
          echo "Downloading TVVLCKit version $VERSION..."
          echo "URL: $TVOS_URL"
          
          # Cleanup and setup
          rm -rf .tmp/ || true
          mkdir -p .tmp/
          
          # Download and extract
          echo "Downloading TVVLCKit..."
          curl -L -o .tmp/TVVLCKit.tar.xz "$TVOS_URL"
          tar -xf .tmp/TVVLCKit.tar.xz -C .tmp/
          
          TVOS_LOCATION=".tmp/TVVLCKit-binary/TVVLCKit.xcframework"
          
          # Verify the framework exists
          if [ ! -d "$TVOS_LOCATION" ]; then
            echo "‚ùå TVVLCKit.xcframework not found at expected location"
            ls -la .tmp/
            exit 1
          fi
          
          # Package tvOS slices (Simulator + Device)
          echo "Creating TVVLCKit.xcframework..."
          xcodebuild -create-xcframework \
              -framework "$TVOS_LOCATION/tvos-arm64_x86_64-simulator/TVVLCKit.framework" \
              -debug-symbols "${PWD}/$TVOS_LOCATION/tvos-arm64_x86_64-simulator/dSYMs/TVVLCKit.framework.dSYM" \
              -framework "$TVOS_LOCATION/tvos-arm64/TVVLCKit.framework" \
              -debug-symbols "${PWD}/$TVOS_LOCATION/tvos-arm64/dSYMs/TVVLCKit.framework.dSYM" \
              -output .tmp/TVVLCKit.xcframework
          
          # Compress the result
          echo "Compressing framework..."
          ditto -c -k --sequesterRsrc --keepParent ".tmp/TVVLCKit.xcframework" ".tmp/TVVLCKit.xcframework.zip"
          
          # Generate checksum
          CHECKSUM=$(shasum -a 256 ".tmp/TVVLCKit.xcframework.zip" | awk '{ print $1 }')
          echo "Checksum: $CHECKSUM"
          
          # Copy license
          if [ -f ".tmp/TVVLCKit-binary/COPYING.txt" ]; then
            cp -f .tmp/TVVLCKit-binary/COPYING.txt ./LICENSE
            echo "‚úÖ License file updated"
          fi
          
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "framework_path=${PWD}/.tmp/TVVLCKit.xcframework.zip" >> $GITHUB_OUTPUT
          echo "‚úÖ Framework packaged successfully"

      - name: Create GitHub Release
        if: steps.check-version.outputs.update_available == 'true'
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.check-version.outputs.latest_version }}
          name: TVVLCKit v${{ steps.check-version.outputs.latest_version }}
          body: |
            Automated update of TVVLCKit framework to version ${{ steps.check-version.outputs.latest_version }}
            
            **Source:** https://code.videolan.org/videolan/VLCKit
            **Download:** ${{ steps.check-version.outputs.download_url }}
            
            **Changes:**
            - Updated TVVLCKit from v${{ steps.check-version.outputs.current_version }} to v${{ steps.check-version.outputs.latest_version }}
            - Updated Package.swift with new checksum
            - Updated LICENSE file
            
            **Checksum:** `${{ steps.package.outputs.checksum }}`
          files: .tmp/TVVLCKit.xcframework.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Package.swift
        if: steps.check-version.outputs.update_available == 'true'
        run: |
          VERSION="${{ steps.check-version.outputs.latest_version }}"
          CHECKSUM="${{ steps.package.outputs.checksum }}"
          
          echo "Updating Package.swift..."
          
          # Update the URL and checksum in Package.swift
          sed -i '' "s|download/v[0-9.]*|download/v$VERSION|g" Package.swift
          sed -i '' "s|checksum: \"[^\"]*\"|checksum: \"$CHECKSUM\"|g" Package.swift
          
          echo "‚úÖ Updated Package.swift"
          echo "--- Package.swift content ---"
          cat Package.swift
          echo "--- End of Package.swift ---"

      - name: Update README
        if: steps.check-version.outputs.update_available == 'true'
        run: |
          CURRENT_VERSION="${{ steps.check-version.outputs.current_version }}"
          NEW_VERSION="${{ steps.check-version.outputs.latest_version }}"
          
          echo "Updating README.md..."
          
          # Check if README exists
          if [ ! -f "README.md" ]; then
            echo "‚ö†Ô∏è README.md not found, skipping..."
            exit 0
          fi
          
          # Update version references in README
          # Update version numbers (e.g., 4.0.0 -> 4.0.1)
          sed -i '' "s/$CURRENT_VERSION/$NEW_VERSION/g" README.md
          
          # Update version tags in URLs (e.g., v4.0.0 -> v4.0.1)
          sed -i '' "s/v$CURRENT_VERSION/v$NEW_VERSION/g" README.md
          
          # Update .upToNextMajor, .upToNextMinor version references if they exist
          sed -i '' "s/from: \"$CURRENT_VERSION\"/from: \"$NEW_VERSION\"/g" README.md
          
          echo "‚úÖ Updated README.md"
          echo "--- README.md changes ---"
          git diff README.md || echo "No changes detected in README.md"
          echo "--- End of README.md changes ---"

      - name: Configure Git for large pushes
        if: steps.check-version.outputs.update_available == 'true'
        run: |
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          git config --global core.compression 0

      - name: Create Pull Request
        if: steps.check-version.outputs.update_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update TVVLCKit to v${{ steps.check-version.outputs.latest_version }}"
          title: "üîÑ Update TVVLCKit to v${{ steps.check-version.outputs.latest_version }}"
          body: |
            ## üéâ New TVVLCKit Version Available
            
            This PR updates the TVVLCKit framework from **v${{ steps.check-version.outputs.current_version }}** to **v${{ steps.check-version.outputs.latest_version }}**.
            
            ### Changes
            - ‚úÖ Downloaded TVVLCKit framework from VideoLAN
            - ‚úÖ Repackaged framework with debug symbols
            - ‚úÖ Created GitHub release [v${{ steps.check-version.outputs.latest_version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.check-version.outputs.latest_version }})
            - ‚úÖ Updated `Package.swift` with new version and checksum
            - ‚úÖ Updated `README.md` with new version number
            - ‚úÖ Updated `LICENSE` file
            
            ### Details
            - **Source URL:** ${{ steps.check-version.outputs.download_url }}
            - **Checksum:** `${{ steps.package.outputs.checksum }}`
            
            ### Testing
            Please test this update in your projects before merging.
            
            ```swift
            dependencies: [
                .package(url: "https://github.com/Lana-Health/TVVLCKit-SPM.git", from: "${{ steps.check-version.outputs.latest_version }}")
            ]
            ```
            
            ---
            ü§ñ This PR was automatically created by the Update TVVLCKit workflow.
          branch: update-tvvlckit-v${{ steps.check-version.outputs.latest_version }}
          delete-branch: true
          labels: |
            dependencies
            automated
            tvos

      - name: Send notification on update
        if: steps.check-version.outputs.update_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîî TVVLCKit Updated to v${{ steps.check-version.outputs.latest_version }}',
              body: `A new version of TVVLCKit is available and has been automatically updated.
              
              **Previous version:** v${{ steps.check-version.outputs.current_version }}
              **New version:** v${{ steps.check-version.outputs.latest_version }}
              
              **What was done:**
              - Downloaded and repackaged the framework
              - Created release: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.check-version.outputs.latest_version }}
              - Updated Package.swift with new checksum
              - Updated README.md with new version number
              - Created pull request for review
              
              **Source:** ${{ steps.check-version.outputs.download_url }}
              
              Please review and merge the pull request when ready.
              
              ü§ñ Automated notification from Update TVVLCKit workflow.`,
              labels: ['notification', 'update-available'],
              assignees: ['apoorva-lana']
            });

      - name: Comment on failure
        if: failure() && steps.check-version.outputs.update_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ùå TVVLCKit Update Failed',
              body: `The automated TVVLCKit update workflow failed while trying to update to v${{ steps.check-version.outputs.latest_version }}.
              
              **Attempted version:** v${{ steps.check-version.outputs.latest_version }}
              **Download URL:** ${{ steps.check-version.outputs.download_url }}
              
              Please check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
              
              ü§ñ Automated notification from Update TVVLCKit workflow.`,
              labels: ['notification', 'error'],
              assignees: ['apoorva-lana']
            });
